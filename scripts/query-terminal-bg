#!/home/jonatan/.local/bin/uvx python
"""Query terminal background color via OSC 11."""

import os
import sys
import termios
import tty
import select
import time

def query_terminal_bg():
    try:
        fd = os.open('/dev/tty', os.O_RDWR | os.O_NOCTTY)
    except OSError:
        return 'dark'

    try:
        old_settings = termios.tcgetattr(fd)
        tty.setraw(fd)
        termios.tcflush(fd, termios.TCIOFLUSH)

        # Send dummy tmux passthrough to reset buffer
        os.write(fd, b'\x1bPtmux;\x1b\x1b]11;?\x1b\x1b\\\x1b\\')
        time.sleep(0.1)

        # Discard any response
        while True:
            ready, _, _ = select.select([fd], [], [], 0.05)
            if not ready:
                break
            os.read(fd, 1000)

        # Now send the real direct query
        os.write(fd, b'\x1b]11;?\x1b\\')

        # Wait for response
        response = b''
        start = time.time()
        while time.time() - start < 0.5:
            ready, _, _ = select.select([fd], [], [], 0.1)
            if ready:
                chunk = os.read(fd, 100)
                if chunk:
                    response += chunk
                    if b'\\' in chunk or b'\x07' in chunk:
                        break

        termios.tcsetattr(fd, termios.TCSANOW, old_settings)
    finally:
        os.close(fd)

    import re
    response = response.decode('latin-1', errors='ignore')
    match = re.search(r'rgb:([0-9a-fA-F]+)/([0-9a-fA-F]+)/([0-9a-fA-F]+)', response)
    if match:
        r = int(match.group(1)[:2], 16)
        g = int(match.group(2)[:2], 16)
        b = int(match.group(3)[:2], 16)
        luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b
        return 'dark' if luminance < 128 else 'light'

    return 'dark'

if __name__ == '__main__':
    # Write directly to stdout (fd 1), not through print
    result = query_terminal_bg()
    os.write(1, (result + '\n').encode())
